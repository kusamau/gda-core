
# Run the "gdastart_servers_pre" scripts to set up the environment as required.
# For Facility, Group, and Instance, there can be a pre-script, and a mode-specific pre-script (all optional)
# Note that in "live" mode, these scripts are run twice, so they must be idempotent:
# (1) on the user machine, when the user issues the gdastart command
# (2) on the control machine, when remotestartupscript.sh issues the gdastart command
# 
for filename in \
  "${GDA_WORKSPACE_PARENT}/${GDA_FACILITY_CONFIG_rel}/bin/gdastart_logpanel_pre_facility" \
  "${GDA_WORKSPACE_PARENT}/${GDA_FACILITY_CONFIG_rel}/etc/${GDA_MODE}/gdastart_logpanel_pre_facility" \
  "${GDA_WORKSPACE_PARENT}/${GDA_GROUP_CONFIG_rel}/bin/gdastart_logpanel_pre_group" \
  "${GDA_WORKSPACE_PARENT}/${GDA_GROUP_CONFIG_rel}/etc/${GDA_MODE}/gdastart_logpanel_pre_group" \
  "${GDA_WORKSPACE_PARENT}/${GDA_INSTANCE_CONFIG_rel}/bin/gdastart_logpanel_pre_instance" \
  "${GDA_WORKSPACE_PARENT}/${GDA_INSTANCE_CONFIG_rel}/etc/${GDA_MODE}/gdastart_logpanel_pre_instance"
do
  if [ -e "${filename}" ]; then
  	echo about to run "${filename}"
    . ${filename}
  fi
done


LOGPANELWINDOW=$(wmctrl -l | grep "GDA Log Panel" | grep -v grep) || true


if [ "$LOGPANELWINDOW" == "" ] ; then
echo 'About to pick which console log file to run'

# Set up the directory and file in which to write the console log
    # We only invoke one script to do this (the most specific one)
    for filename in \
      "${GDA_WORKSPACE_PARENT}/${GDA_INSTANCE_CONFIG_rel}/bin/gda_setup_consolelog_instance" \
      "${GDA_WORKSPACE_PARENT}/${GDA_GROUP_CONFIG_rel}/bin/gda_setup_consolelog_group" \
      "${GDA_WORKSPACE_PARENT}/${GDA_FACILITY_CONFIG_rel}/bin/gda_setup_consolelog_facility"
    do
      if [ -e "${filename}" ]; then
        . ${filename}
        echo "just ran ${filename}"
        break
      fi
    done

  GDA_LOGPANEL_APP=/dls_sw/apps/gdalogpanel/gdalogpanel/gdalogpanel
  GDA_LOGPANEL_APP_ARGS="-vmargs -Dgda.propertiesFile=${GDA_WORKSPACE_PARENT}/${GDA_INSTANCE_CONFIG_rel}/properties/${GDA_MODE}/java.properties -Dgda.install.git.loc=${GDA_WORKSPACE_PARENT}/workspace_git"

  echo Starting GDA Log Panel...
  echo GDA_INSTANCE_CONFIG_rel = $GDA_INSTANCE_CONFIG_rel , BEAMLINE = $BEAMLINE , GDA_MODE = $GDA_MODE
  
  echo  $GDA_LOGPANEL_APP $GDA_LOGPANEL_APP_ARGS
  echo  $GDA_LOGPANEL_APP $GDA_LOGPANEL_APP_ARGS >> ${GDA_logpanel_CONSOLE_LOG}
  nohup $GDA_LOGPANEL_APP $GDA_LOGPANEL_APP_ARGS >> ${GDA_logpanel_CONSOLE_LOG} 2>&1 &

else
  echo Raising GDA Log Panel...
  wmctrl -R "GDA Log Panel"
fi